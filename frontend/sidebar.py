import streamlit as st
from typing import Optional

def render_sidebar(
    today_count: int = 247,
    today_delta: str = "+42",
    accuracy_text: str = "87.2%",
    accuracy_delta: str = "+3.1%",
    guide_title: str = "คู่มือการใช้งาน",
    guide_subtitle: str = "ปัญญาโบราณ & AI ยุคใหม่",
    supported_formats: str = "JPG, JPEG, PNG, WEBP, HEIC, HEIF, BMP, TIFF",
    max_file_size_mb: int = 10,
    api_url: Optional[str] = None,
    app_version: str = "v2.1.0",
) -> None:
    # Header Card
    st.markdown(
        f"""
<div class="sidebar-card">
  <h3 class="accent" style="margin:.25rem 0 0">{guide_title}</h3>
  <p class="sidebar-muted" style="margin:.35rem 0 0;">{guide_subtitle}</p>
</div>
""",
        unsafe_allow_html=True,
    )

    # ขั้นตอนการวิเคราะห์ (ละเอียดขึ้น)
    with st.expander("ขั้นตอนการวิเคราะห์", expanded=True):
        st.markdown(
            f"""
**0) ก่อนเริ่ม**  
- ตรวจสอบไฟล์: รองรับ {supported_formats}  
- ขนาดไฟล์ไม่เกิน **{max_file_size_mb}MB** ต่อไฟล์  
- ความละเอียดที่แนะนำ ≥ **1080p** (คมชัด อ่านลายผิวได้)  

**1) เตรียมรูปภาพ**  
- ด้านหน้า (จำเป็น) • ด้านหลัง (จำเป็น)  
- จัดวางพระให้ตรงกลาง ภาพไม่เอียง ขอบไม่ถูกตัด  

**2) วิธีอัปโหลด**  
- เลือกไฟล์จากเครื่อง หรือถ่ายด้วยกล้องจากหน้าแอป  
- ตรวจดูตัวอย่างภาพว่าไม่เบลอ/มืด/สะท้อนแสง  

**3) ประมวลผลด้วย AI**  
- ระบบปรับสเกล/แปลงสีอัตโนมัติ  
- วิเคราะห์ลวดลาย–พื้นผิว–สภาพผิว และคุณลักษณะเด่น  
- เทียบฐานข้อมูลอ้างอิงเพื่อให้ **Top-k** การจำแนก  

**4) ผลลัพธ์**  
- แสดงผลลัพธ์หลัก + ความมั่นใจ (%)  
- ช่วงราคาประเมิน **P05 / P50 / P95**  
- ข้อเสนอแนะแนวทางตลาด/แพลตฟอร์มที่เหมาะสม  

**5) ภายหลังการวิเคราะห์**  
- ภาพที่อัปโหลดจะถูกลบออกหลังประมวลผลเสร็จ (ไม่เก็บถาวร)  
- ใช้ผลเพื่อประกอบการตัดสินใจ ควรตรวจสอบกับผู้เชี่ยวชาญเพิ่มเติม
"""
        )

    # ข้อมูลระบบ (ขยายรายละเอียด)
    with st.expander("ข้อมูลระบบ"):
        st.markdown(
            f"""
**เทคโนโลยีที่ใช้**  
- **AI Engine**: Transfer Learning + Custom CNN  
- **Backend**: FastAPI • Python 3.9+  
- **Frontend**: Streamlit (Responsive)  

**การประมวลผล**  
- เวลาเฉลี่ยต่อคู่ภาพ: **30–60 วินาที** (ขึ้นกับขนาดไฟล์/โหลดระบบ)  
- ฐานข้อมูลอ้างอิง: **5,000+** ตัวอย่าง (อัปเดตรายเดือน)  
- การให้คะแนน: Top-k พร้อม **Confidence Score** รายคลาส  

**ความเป็นส่วนตัว**  
- ประมวลผลแบบชั่วคราว ภาพไม่ถูกเก็บถาวร  
- ไม่ใช้ข้อมูลส่วนบุคคลเพื่อการโฆษณา/การติดตาม  

**สภาพแวดล้อม/ดีบัก**  
- API Endpoint: `{api_url or "http://localhost:8000/predict"}`  
- App Version: **{app_version}**  
"""
        )

    # เคล็ดลับการถ่ายภาพ (เชิงปฏิบัติ)
    with st.expander("เคล็ดลับการถ่ายภาพ"):
        st.markdown(
            """
**แสงสว่าง**  
- ใช้แสงธรรมชาติ หรือไฟขาวนุ่ม ๆ กระจายสม่ำเสมอ  
- หลีกเลี่ยงเงาแข็ง/จุดสะท้อนบนผิวพระ  

**มุมและระยะ**  
- ถ่ายตั้งฉาก 90° ระยะ 20–30 ซม.  
- ใส่กรอบภาพให้เหลือพื้นที่รอบพระเล็กน้อยเพื่อป้องกันตัดขอบ  

**พื้นหลัง**  
- ฉากเรียบ สีอ่อน ไม่สะท้อนแสง  

**คุณภาพภาพ**  
- ทำความสะอาดเลนส์ก่อนถ่าย  
- ปิด Digital Zoom • ไม่ใช้ฟิลเตอร์แต่งภาพ  
- หากเป็น HEIC แล้วอัปโหลดไม่ได้ ให้บันทึกเป็น JPG/PNG ก่อน  
"""
        )

    # หมายเหตุสำคัญ (ชัดเจนขึ้น)
    with st.expander("หมายเหตุสำคัญ"):
        st.info(
            "สถานะระบบ: เบต้า • ใช้เพื่อประกอบการพิจารณา • "
            "ผลลัพธ์อาจคลาดเคลื่อนได้ในบางกรณี (สภาพผิว/ภาพถ่าย/รุ่นย่อย) • "
            "ภาพจะถูกลบหลังประมวลผลเสร็จ"
        )

    # สถิติใช้งาน
    st.markdown("---")
    st.markdown("#### สถิติการใช้งาน")
    c1, c2 = st.columns(2)
    with c1:
        st.metric("วันนี้", f"{today_count}", today_delta)
    with c2:
        st.metric("ความแม่นยำ", accuracy_text, accuracy_delta)

    # Troubleshooting / FAQ สั้น ๆ
    st.markdown("---")
    with st.expander("ปัญหาที่พบบ่อย (FAQ)"):
        st.markdown(
            f"""
**อัปโหลดไฟล์ไม่ได้**  
- ตรวจสอบนามสกุลไฟล์ (รองรับ {supported_formats}) และขนาดไม่เกิน {max_file_size_mb}MB  

**ผลลัพธ์ไม่เสถียร**  
- ถ่ายใหม่ให้คมชัดขึ้น เพิ่มแสง ลดเงา/แสงสะท้อน  
- อัปโหลดทั้งด้านหน้าและหลังเสมอ  

**เซิร์ฟเวอร์ไม่ตอบสนอง**  
- ตรวจสอบการเชื่อมต่อ และค่า API URL ให้ถูกต้อง  
"""
        )

    # Footer ช่วยเหลือ
    st.markdown(
        """
<div class="sidebar-help">
  ต้องการความช่วยเหลือเพิ่มเติม? ติดต่อทีมงานได้ทุกเวลา
</div>
""",
        unsafe_allow_html=True,
    )
